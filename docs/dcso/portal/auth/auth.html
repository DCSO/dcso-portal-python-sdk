<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.1" />
<title>dcso.portal.auth.auth API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>dcso.portal.auth.auth</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># Copyright (c) 2020, 2021, DCSO GmbH

from datetime import datetime
from typing import Optional

from .rbac import RBACMixin
from .token import Token
from ..abstracts import APIAbstract
from ..exceptions import PortalAPIResponse, PortalException
from ..util.graphql import GraphQLRequest

_DEFAULT_TOKEN_RESOURCE = &#34;PortalPythonSDK&#34;


class Authentication:
    def __init__(self, graphql_response: Optional[dict]):
        self.id: str = &#39;&#39;
        self.username: str = &#39;&#39;
        self.token: Optional[Token] = None
        self.token_is_temporary: bool = False
        self.groups = []  # legacy: replaced by permissions

        self.totp_required: bool = True
        self.totp_activated: Optional[datetime] = None
        self.totp_qrcode: Optional[str] = None

        if graphql_response:
            self._handle_graphql_response(graphql_response)

    def _handle_graphql_response(self, res: dict):
        try:
            self.token = Token(graphql_response=res)

            if res[&#39;user&#39;]:
                self.id = res[&#39;user&#39;][&#39;id&#39;]
                self.username = res[&#39;user&#39;][&#39;username&#39;]

            self.totp_required = res[&#39;otp&#39;][&#39;required&#39;]
            self.totp_activated = res[&#39;otp&#39;][&#39;activated&#39;]
            self.token_is_temporary = res[&#39;isTemporaryToken&#39;]
        except KeyError as exc:
            raise PortalAPIResponse(f&#34;failed handling authentication response ({exc})&#34;)


class Auth(RBACMixin):
    &#34;&#34;&#34;Auth provides authentication, authorization, and user management.

    Typical use:

        api = APIClient(&#39;https://api.example.com/api&#39;)
        auth = Auth(api)
        user = auth.authenticate(&#34;alice&#34;, &#34;alice.password&#34;)
    &#34;&#34;&#34;

    @property
    def token(self) -&gt; str:
        return self._api.token

    @token.setter
    def token(self, token: str) -&gt; None:
        self._api.token = token

    def __init__(self, api: APIAbstract):
        self._api: APIAbstract = api

    def authenticate(self, username: str, password: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                     set_api_token: bool = True) -&gt; Authentication:
        &#34;&#34;&#34;Authenticates with DCSO Portal using credentials or `username` and `password`,
        for the given `resource`. Resource is by default `PortalPythonSDK`, but it can
        be, for example, the name of the application or script.

        When the authenticating user has two-factor authentication (2FA) enforced, a second
        pass is needed using the temporary token received with by method and passed
        on to the `second_authentication_totp` method.

        When `set_api_token` is True, and authentication succeeds, the non-temporary
        token will be stored and used for further API queries.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;password&#34;: password,
                &#34;resource&#34;: resource
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if not authn.token_is_temporary and set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise

    def second_authentication_totp(self, username: str, temp_token: str, totp: str,
                                   set_api_token: bool = True,
                                   resource: str = _DEFAULT_TOKEN_RESOURCE) -&gt; Authentication:
        &#34;&#34;&#34;Two-factor authentication using Time-based One-Time Password (TOTP).

        The `username` must be the same which was used with the `authenticate` method. The
        `temp_token` argument is set to the temporary token returned by the method
        `authenticate`. Finally, the `totp` argument is the code visible in the
        authenticator application which holds the TOTP secret.

        The `resource` argument is by default `PortalPythonSDK`, but it can
        be, for example, the name of the application or script. This must match the resource
        that was used with `authenticate()`.

        When `set_api_token` is True, and authentication succeeds, the non-temporary
        token will be stored and used for further API queries.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;temporaryToken&#34;: temp_token,
                &#34;otpCode&#34;: totp,
                &#34;resource&#34;: resource,
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise

    def refresh_jwt_token(self, username: str, token: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                          set_api_token: bool = True) -&gt; Authentication:
        &#34;&#34;&#34;Refreshes a User Token (JWT) with DCSO Portal

        JWTs (JSON Web Tokens) usually have a short lifespan, but they can be refreshed
        provided the previous `token` is still valid. The `username` and `resource` must
        match those of the original token.  A new token will be returned, rendering
        previous unusable.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;refreshToken&#34;: token,
                &#34;resource&#34;: resource,
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException as exc:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise


_GRAPHQL_MUTATION_AUTHN = &#34;&#34;&#34;
mutation ($portalauth: auth_AuthorizationInput!) {
  portalauth: auth_createAuthorization(input: $portalauth) {
    user {
        id
        username
        accessTo {
            service { id code }
            group { code }
        }
    }
    token
    isTemporaryToken
    otp {
      required
      activated
    }
    otpSVGQRCode
  }
}
&#34;&#34;&#34;</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="dcso.portal.auth.auth.Auth"><code class="flex name class">
<span>class <span class="ident">Auth</span></span>
<span>(</span><span>api: <a title="dcso.portal.abstracts.APIAbstract" href="../abstracts.html#dcso.portal.abstracts.APIAbstract">APIAbstract</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>Auth provides authentication, authorization, and user management.</p>
<p>Typical use:</p>
<pre><code>api = APIClient('https://api.example.com/api')
auth = Auth(api)
user = auth.authenticate("alice", "alice.password")
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Auth(RBACMixin):
    &#34;&#34;&#34;Auth provides authentication, authorization, and user management.

    Typical use:

        api = APIClient(&#39;https://api.example.com/api&#39;)
        auth = Auth(api)
        user = auth.authenticate(&#34;alice&#34;, &#34;alice.password&#34;)
    &#34;&#34;&#34;

    @property
    def token(self) -&gt; str:
        return self._api.token

    @token.setter
    def token(self, token: str) -&gt; None:
        self._api.token = token

    def __init__(self, api: APIAbstract):
        self._api: APIAbstract = api

    def authenticate(self, username: str, password: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                     set_api_token: bool = True) -&gt; Authentication:
        &#34;&#34;&#34;Authenticates with DCSO Portal using credentials or `username` and `password`,
        for the given `resource`. Resource is by default `PortalPythonSDK`, but it can
        be, for example, the name of the application or script.

        When the authenticating user has two-factor authentication (2FA) enforced, a second
        pass is needed using the temporary token received with by method and passed
        on to the `second_authentication_totp` method.

        When `set_api_token` is True, and authentication succeeds, the non-temporary
        token will be stored and used for further API queries.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;password&#34;: password,
                &#34;resource&#34;: resource
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if not authn.token_is_temporary and set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise

    def second_authentication_totp(self, username: str, temp_token: str, totp: str,
                                   set_api_token: bool = True,
                                   resource: str = _DEFAULT_TOKEN_RESOURCE) -&gt; Authentication:
        &#34;&#34;&#34;Two-factor authentication using Time-based One-Time Password (TOTP).

        The `username` must be the same which was used with the `authenticate` method. The
        `temp_token` argument is set to the temporary token returned by the method
        `authenticate`. Finally, the `totp` argument is the code visible in the
        authenticator application which holds the TOTP secret.

        The `resource` argument is by default `PortalPythonSDK`, but it can
        be, for example, the name of the application or script. This must match the resource
        that was used with `authenticate()`.

        When `set_api_token` is True, and authentication succeeds, the non-temporary
        token will be stored and used for further API queries.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;temporaryToken&#34;: temp_token,
                &#34;otpCode&#34;: totp,
                &#34;resource&#34;: resource,
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise

    def refresh_jwt_token(self, username: str, token: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                          set_api_token: bool = True) -&gt; Authentication:
        &#34;&#34;&#34;Refreshes a User Token (JWT) with DCSO Portal

        JWTs (JSON Web Tokens) usually have a short lifespan, but they can be refreshed
        provided the previous `token` is still valid. The `username` and `resource` must
        match those of the original token.  A new token will be returned, rendering
        previous unusable.

        An Authentication instance is returned which contains general user information,
        token, and details about this token.

        Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
        When there was an issue with the request itself, or decoding JSON failed,
        the `PortalAPIRequest` exception is raised.
        &#34;&#34;&#34;
        variables = {
            &#34;portalauth&#34;: {
                &#34;username&#34;: username,
                &#34;refreshToken&#34;: token,
                &#34;resource&#34;: resource,
            }
        }

        request = GraphQLRequest(api_url=self._api.api_url,
                                 query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

        try:
            response = request.execute_dict()
        except PortalException as exc:
            raise

        try:
            authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
            if set_api_token:
                self._api.token = authn.token.token
            return authn
        except PortalAPIResponse:
            raise</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="dcso.portal.auth.rbac.RBACMixin" href="rbac.html#dcso.portal.auth.rbac.RBACMixin">RBACMixin</a></li>
<li><a title="dcso.portal.abstracts.ServiceAbstract" href="../abstracts.html#dcso.portal.abstracts.ServiceAbstract">ServiceAbstract</a></li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="dcso.portal.auth.auth.Auth.token"><code class="name">var <span class="ident">token</span> : str</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def token(self) -&gt; str:
    return self._api.token</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="dcso.portal.auth.auth.Auth.authenticate"><code class="name flex">
<span>def <span class="ident">authenticate</span></span>(<span>self, username: str, password: str, resource: str = 'PortalPythonSDK', set_api_token: bool = True) ‑> <a title="dcso.portal.auth.auth.Authentication" href="#dcso.portal.auth.auth.Authentication">Authentication</a></span>
</code></dt>
<dd>
<div class="desc"><p>Authenticates with DCSO Portal using credentials or <code>username</code> and <code>password</code>,
for the given <code>resource</code>. Resource is by default <code>PortalPythonSDK</code>, but it can
be, for example, the name of the application or script.</p>
<p>When the authenticating user has two-factor authentication (2FA) enforced, a second
pass is needed using the temporary token received with by method and passed
on to the <code>second_authentication_totp</code> method.</p>
<p>When <code>set_api_token</code> is True, and authentication succeeds, the non-temporary
token will be stored and used for further API queries.</p>
<p>An Authentication instance is returned which contains general user information,
token, and details about this token.</p>
<p>Raises <code>PortalAPIError</code> When the GraphQL API endpoint returned an error.
When there was an issue with the request itself, or decoding JSON failed,
the <code>PortalAPIRequest</code> exception is raised.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def authenticate(self, username: str, password: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                 set_api_token: bool = True) -&gt; Authentication:
    &#34;&#34;&#34;Authenticates with DCSO Portal using credentials or `username` and `password`,
    for the given `resource`. Resource is by default `PortalPythonSDK`, but it can
    be, for example, the name of the application or script.

    When the authenticating user has two-factor authentication (2FA) enforced, a second
    pass is needed using the temporary token received with by method and passed
    on to the `second_authentication_totp` method.

    When `set_api_token` is True, and authentication succeeds, the non-temporary
    token will be stored and used for further API queries.

    An Authentication instance is returned which contains general user information,
    token, and details about this token.

    Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
    When there was an issue with the request itself, or decoding JSON failed,
    the `PortalAPIRequest` exception is raised.
    &#34;&#34;&#34;
    variables = {
        &#34;portalauth&#34;: {
            &#34;username&#34;: username,
            &#34;password&#34;: password,
            &#34;resource&#34;: resource
        }
    }

    request = GraphQLRequest(api_url=self._api.api_url,
                             query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

    try:
        response = request.execute_dict()
    except PortalException:
        raise

    try:
        authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
        if not authn.token_is_temporary and set_api_token:
            self._api.token = authn.token.token
        return authn
    except PortalAPIResponse:
        raise</code></pre>
</details>
</dd>
<dt id="dcso.portal.auth.auth.Auth.refresh_jwt_token"><code class="name flex">
<span>def <span class="ident">refresh_jwt_token</span></span>(<span>self, username: str, token: str, resource: str = 'PortalPythonSDK', set_api_token: bool = True) ‑> <a title="dcso.portal.auth.auth.Authentication" href="#dcso.portal.auth.auth.Authentication">Authentication</a></span>
</code></dt>
<dd>
<div class="desc"><p>Refreshes a User Token (JWT) with DCSO Portal</p>
<p>JWTs (JSON Web Tokens) usually have a short lifespan, but they can be refreshed
provided the previous <code>token</code> is still valid. The <code>username</code> and <code>resource</code> must
match those of the original token.
A new token will be returned, rendering
previous unusable.</p>
<p>An Authentication instance is returned which contains general user information,
token, and details about this token.</p>
<p>Raises <code>PortalAPIError</code> When the GraphQL API endpoint returned an error.
When there was an issue with the request itself, or decoding JSON failed,
the <code>PortalAPIRequest</code> exception is raised.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def refresh_jwt_token(self, username: str, token: str, resource: str = _DEFAULT_TOKEN_RESOURCE,
                      set_api_token: bool = True) -&gt; Authentication:
    &#34;&#34;&#34;Refreshes a User Token (JWT) with DCSO Portal

    JWTs (JSON Web Tokens) usually have a short lifespan, but they can be refreshed
    provided the previous `token` is still valid. The `username` and `resource` must
    match those of the original token.  A new token will be returned, rendering
    previous unusable.

    An Authentication instance is returned which contains general user information,
    token, and details about this token.

    Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
    When there was an issue with the request itself, or decoding JSON failed,
    the `PortalAPIRequest` exception is raised.
    &#34;&#34;&#34;
    variables = {
        &#34;portalauth&#34;: {
            &#34;username&#34;: username,
            &#34;refreshToken&#34;: token,
            &#34;resource&#34;: resource,
        }
    }

    request = GraphQLRequest(api_url=self._api.api_url,
                             query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

    try:
        response = request.execute_dict()
    except PortalException as exc:
        raise

    try:
        authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
        if set_api_token:
            self._api.token = authn.token.token
        return authn
    except PortalAPIResponse:
        raise</code></pre>
</details>
</dd>
<dt id="dcso.portal.auth.auth.Auth.second_authentication_totp"><code class="name flex">
<span>def <span class="ident">second_authentication_totp</span></span>(<span>self, username: str, temp_token: str, totp: str, set_api_token: bool = True, resource: str = 'PortalPythonSDK') ‑> <a title="dcso.portal.auth.auth.Authentication" href="#dcso.portal.auth.auth.Authentication">Authentication</a></span>
</code></dt>
<dd>
<div class="desc"><p>Two-factor authentication using Time-based One-Time Password (TOTP).</p>
<p>The <code>username</code> must be the same which was used with the <code>authenticate</code> method. The
<code>temp_token</code> argument is set to the temporary token returned by the method
<code>authenticate</code>. Finally, the <code>totp</code> argument is the code visible in the
authenticator application which holds the TOTP secret.</p>
<p>The <code>resource</code> argument is by default <code>PortalPythonSDK</code>, but it can
be, for example, the name of the application or script. This must match the resource
that was used with <code>authenticate()</code>.</p>
<p>When <code>set_api_token</code> is True, and authentication succeeds, the non-temporary
token will be stored and used for further API queries.</p>
<p>An Authentication instance is returned which contains general user information,
token, and details about this token.</p>
<p>Raises <code>PortalAPIError</code> When the GraphQL API endpoint returned an error.
When there was an issue with the request itself, or decoding JSON failed,
the <code>PortalAPIRequest</code> exception is raised.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def second_authentication_totp(self, username: str, temp_token: str, totp: str,
                               set_api_token: bool = True,
                               resource: str = _DEFAULT_TOKEN_RESOURCE) -&gt; Authentication:
    &#34;&#34;&#34;Two-factor authentication using Time-based One-Time Password (TOTP).

    The `username` must be the same which was used with the `authenticate` method. The
    `temp_token` argument is set to the temporary token returned by the method
    `authenticate`. Finally, the `totp` argument is the code visible in the
    authenticator application which holds the TOTP secret.

    The `resource` argument is by default `PortalPythonSDK`, but it can
    be, for example, the name of the application or script. This must match the resource
    that was used with `authenticate()`.

    When `set_api_token` is True, and authentication succeeds, the non-temporary
    token will be stored and used for further API queries.

    An Authentication instance is returned which contains general user information,
    token, and details about this token.

    Raises `PortalAPIError` When the GraphQL API endpoint returned an error.
    When there was an issue with the request itself, or decoding JSON failed,
    the `PortalAPIRequest` exception is raised.
    &#34;&#34;&#34;
    variables = {
        &#34;portalauth&#34;: {
            &#34;username&#34;: username,
            &#34;temporaryToken&#34;: temp_token,
            &#34;otpCode&#34;: totp,
            &#34;resource&#34;: resource,
        }
    }

    request = GraphQLRequest(api_url=self._api.api_url,
                             query=_GRAPHQL_MUTATION_AUTHN, variables=variables)

    try:
        response = request.execute_dict()
    except PortalException:
        raise

    try:
        authn = Authentication(graphql_response=response[&#39;data&#39;][&#39;portalauth&#39;])
        if set_api_token:
            self._api.token = authn.token.token
        return authn
    except PortalAPIResponse:
        raise</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="dcso.portal.auth.rbac.RBACMixin" href="rbac.html#dcso.portal.auth.rbac.RBACMixin">RBACMixin</a></b></code>:
<ul class="hlist">
<li><code><a title="dcso.portal.auth.rbac.RBACMixin.user_service_permissions" href="rbac.html#dcso.portal.auth.rbac.RBACMixin.user_service_permissions">user_service_permissions</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="dcso.portal.auth.auth.Authentication"><code class="flex name class">
<span>class <span class="ident">Authentication</span></span>
<span>(</span><span>graphql_response: Union[dict, NoneType])</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Authentication:
    def __init__(self, graphql_response: Optional[dict]):
        self.id: str = &#39;&#39;
        self.username: str = &#39;&#39;
        self.token: Optional[Token] = None
        self.token_is_temporary: bool = False
        self.groups = []  # legacy: replaced by permissions

        self.totp_required: bool = True
        self.totp_activated: Optional[datetime] = None
        self.totp_qrcode: Optional[str] = None

        if graphql_response:
            self._handle_graphql_response(graphql_response)

    def _handle_graphql_response(self, res: dict):
        try:
            self.token = Token(graphql_response=res)

            if res[&#39;user&#39;]:
                self.id = res[&#39;user&#39;][&#39;id&#39;]
                self.username = res[&#39;user&#39;][&#39;username&#39;]

            self.totp_required = res[&#39;otp&#39;][&#39;required&#39;]
            self.totp_activated = res[&#39;otp&#39;][&#39;activated&#39;]
            self.token_is_temporary = res[&#39;isTemporaryToken&#39;]
        except KeyError as exc:
            raise PortalAPIResponse(f&#34;failed handling authentication response ({exc})&#34;)</code></pre>
</details>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<header>
<a class="homelink" rel="home" title="pdoc Home" href="https://dcso.de">
<img src="https://avatars1.githubusercontent.com/u/17251161?s=200&v=4" width="52"> DCSO</a> Portal Python SDK
</header>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="dcso.portal.auth" href="index.html">dcso.portal.auth</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="dcso.portal.auth.auth.Auth" href="#dcso.portal.auth.auth.Auth">Auth</a></code></h4>
<ul class="">
<li><code><a title="dcso.portal.auth.auth.Auth.authenticate" href="#dcso.portal.auth.auth.Auth.authenticate">authenticate</a></code></li>
<li><code><a title="dcso.portal.auth.auth.Auth.refresh_jwt_token" href="#dcso.portal.auth.auth.Auth.refresh_jwt_token">refresh_jwt_token</a></code></li>
<li><code><a title="dcso.portal.auth.auth.Auth.second_authentication_totp" href="#dcso.portal.auth.auth.Auth.second_authentication_totp">second_authentication_totp</a></code></li>
<li><code><a title="dcso.portal.auth.auth.Auth.token" href="#dcso.portal.auth.auth.Auth.token">token</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="dcso.portal.auth.auth.Authentication" href="#dcso.portal.auth.auth.Authentication">Authentication</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<div style="width: 100%; display: flex; justify-content: flex-end">
<div>
<p>Copyright (c) 2020, <a href="https://dcso.de">DCSO Deutsche Cyber-Sicherheitsorganisation GmbH</a></p>
</div>
<div>
<p><strong>v1.0.0-beta3</strong></p>
</div>
</div>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/dcso/dcso-portal-python-sdk" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</footer>
</body>
</html>